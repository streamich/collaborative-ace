"use strict";(self.webpackChunkcollaborative_ace=self.webpackChunkcollaborative_ace||[]).push([[987],{"./src/index.stories.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{Primary:()=>Primary,__namedExportsOrder:()=>__namedExportsOrder,default:()=>index_stories});var react=__webpack_require__("./node_modules/react/index.js"),json_crdt=__webpack_require__("./node_modules/json-joy/es2020/json-crdt/index.js"),lib=__webpack_require__("./node_modules/react-ace/lib/index.js"),collaborative_editor_lib=__webpack_require__("./node_modules/collaborative-editor/lib/index.js");class AceEditorFacade{constructor(editor){this.editor=editor,editor.on("change",this.onChange)}onChange=delta=>{if(delta&&"object"==typeof delta&&delta.start&&delta.end){const start=this.editor.session.doc.positionToIndex(delta.start),text=delta.lines.join("\n");switch(delta.action){case"insert":this.onchange?.([[start,0,text]]);break;case"remove":this.onchange?.([[start,text.length,""]]);break;default:this.onchange?.()}}else this.onchange?.()};get(){return this.editor.getValue()}getLength(){const doc=this.editor.session.doc,nl=doc.getNewLineCharacter().length,lines=doc.getAllLines();let length=0;for(let i=0;i<lines.length;i++)length+=lines[i].length+nl;return length-=nl,length}set(text){this.editor.setValue(text)}ins(pos,text){const session=this.editor.session,position=session.doc.indexToPosition(pos,0);session.insert(position,text)}del(pos,len){const session=this.editor.session,doc=session.doc,R=session.selection.getRange().constructor,start=doc.indexToPosition(pos,0),end=doc.indexToPosition(pos+len,0),range=new R(start.row,start.column,end.row,end.column);session.remove(range)}dispose(){this.editor.off("change",this.onChange)}}var jsx_runtime=__webpack_require__("./node_modules/react/jsx-runtime.js");const Editor=_ref=>{let{src=""}=_ref;const editorRef=react.useRef(null),unbindRef=react.useRef(null),[model,clone]=react.useMemo((()=>{const model=json_crdt.Model.withLogicalClock();return model.api.root(src),[model,model.clone()]}),[]);react.useSyncExternalStore(model.api.subscribe,(()=>model.tick)),react.useEffect((()=>()=>{unbindRef.current?.()}),[]);return(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsx)(lib.cp,{onLoad:editor=>{editorRef.current=editor,unbindRef.current=((str,editor,polling)=>collaborative_editor_lib.StrBinding.bind(str,new AceEditorFacade(editor),polling))(model.api.str([]),editor,!0)}}),(0,jsx_runtime.jsx)("div",{children:(0,jsx_runtime.jsx)("button",{onClick:()=>((text,position)=>{const editor=editorRef.current;if(!editor)return;const session=editor.session,doc=session.doc,pos=position??editor.getValue().length,docPos=doc.indexToPosition(pos,0);session.insert(docPos,text)})("!"),children:'Append "!" to editor'})}),(0,jsx_runtime.jsx)("div",{children:(0,jsx_runtime.jsx)("button",{onClick:()=>setTimeout((()=>{const str=model.api.str([]);str.ins(str.length(),"?")}),2e3),children:'Append "?" to model after 2s'})}),(0,jsx_runtime.jsx)("div",{children:(0,jsx_runtime.jsx)("button",{onClick:()=>setTimeout((()=>{model.api.str([]).ins(0,"1. ")}),2e3),children:'Prepend "1. " to model after 2s'})}),(0,jsx_runtime.jsx)("div",{children:(0,jsx_runtime.jsx)("button",{onClick:()=>{setTimeout((()=>{model.reset(clone)}),2e3)},children:"RESET after 2s"})}),(0,jsx_runtime.jsx)("div",{children:(0,jsx_runtime.jsx)("button",{onClick:()=>{setTimeout((()=>{model.api.str([]).del(0,1)}),2e3)},children:"Delete model first char after 2s"})}),(0,jsx_runtime.jsx)("pre",{style:{fontSize:"10px"},children:(0,jsx_runtime.jsx)("code",{children:model.root+""})})]})};Editor.displayName="Editor";const index_stories={title:"CodeMirror Editor",component:Editor,argTypes:{}},Primary={args:{src:"gl"}};Primary.parameters={...Primary.parameters,docs:{...Primary.parameters?.docs,source:{originalSource:"{\n  args: {\n    src: 'gl'\n  }\n}",...Primary.parameters?.docs?.source}}};const __namedExportsOrder=["Primary"]}}]);